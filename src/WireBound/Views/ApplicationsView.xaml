<UserControl x:Class="WireBound.Views.ApplicationsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:converters="clr-namespace:WireBound.Converters"
             Background="Transparent">

    <UserControl.Resources>
        <converters:ByteFormatConverter x:Key="ByteFormatConverter"/>
        <converters:SpeedFormatConverter x:Key="SpeedFormatConverter"/>
    </UserControl.Resources>

    <Grid>
        <!-- Loading Overlay -->
        <Border Background="#80000000" 
                Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibilityConverter}}"
                Panel.ZIndex="100">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <TextBlock Text="Loading..." 
                           Style="{StaticResource HeaderText}" 
                           HorizontalAlignment="Center"/>
            </StackPanel>
        </Border>

        <ScrollViewer VerticalScrollBarVisibility="Auto">
            <StackPanel Margin="8">
                <!-- Header -->
                <TextBlock Text="Applications" Style="{StaticResource HeaderText}" Margin="8,0,0,16"/>

                <!-- Filter Bar -->
                <Border Style="{StaticResource CardStyle}">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <!-- Date Range -->
                        <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                            <TextBlock Text="From:" Style="{StaticResource BodyText}" VerticalAlignment="Center" Margin="0,0,8,0"/>
                            <DatePicker SelectedDate="{Binding StartDate, Converter={StaticResource DateOnlyConverter}}" 
                                        Width="120" Margin="0,0,16,0"/>
                            <TextBlock Text="To:" Style="{StaticResource BodyText}" VerticalAlignment="Center" Margin="0,0,8,0"/>
                            <DatePicker SelectedDate="{Binding EndDate, Converter={StaticResource DateOnlyConverter}}" 
                                        Width="120"/>
                        </StackPanel>

                        <!-- Search Box -->
                        <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center" Margin="16,0">
                            <TextBlock Text="ðŸ”" FontSize="14" VerticalAlignment="Center" Margin="0,0,8,0"/>
                            <TextBox Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}" 
                                     Width="200" 
                                     VerticalAlignment="Center"
                                     Style="{StaticResource TextBoxStyle}"/>
                        </StackPanel>

                        <!-- Group By -->
                        <StackPanel Grid.Column="3" Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,16,0">
                            <TextBlock Text="Group by:" Style="{StaticResource BodyText}" VerticalAlignment="Center" Margin="0,0,8,0"/>
                            <ComboBox ItemsSource="{Binding GroupByOptions}" 
                                      SelectedItem="{Binding SelectedGroupBy}"
                                      Width="140"
                                      Style="{StaticResource ComboBoxStyle}"/>
                        </StackPanel>

                        <!-- Buttons -->
                        <StackPanel Grid.Column="4" Orientation="Horizontal">
                            <Button Content="ðŸ”„ Refresh" 
                                    Command="{Binding RefreshCommand}" 
                                    Style="{StaticResource SecondaryButtonStyle}"
                                    Margin="0,0,8,0"/>
                            <Button Content="âœ– Clear" 
                                    Command="{Binding ClearFiltersCommand}" 
                                    Style="{StaticResource SecondaryButtonStyle}"/>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Summary Cards -->
                <Grid Margin="0,8,0,8">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <Border Grid.Column="0" Style="{StaticResource CardStyle}">
                        <StackPanel>
                            <TextBlock Text="ðŸ“Š Total Apps" Style="{StaticResource SubHeaderText}" FontSize="14"/>
                            <TextBlock Text="{Binding AppCount}" FontSize="24" FontWeight="SemiBold" 
                                       Foreground="{StaticResource TextPrimaryBrush}" Margin="0,8,0,0"/>
                        </StackPanel>
                    </Border>

                    <Border Grid.Column="1" Style="{StaticResource CardStyle}">
                        <StackPanel>
                            <TextBlock Text="â†“ Total Download" Style="{StaticResource SubHeaderText}" FontSize="14"/>
                            <TextBlock Text="{Binding TotalDownload}" FontSize="24" FontWeight="SemiBold" 
                                       Foreground="{StaticResource DownloadBrush}" Margin="0,8,0,0"/>
                        </StackPanel>
                    </Border>

                    <Border Grid.Column="2" Style="{StaticResource CardStyle}">
                        <StackPanel>
                            <TextBlock Text="â†‘ Total Upload" Style="{StaticResource SubHeaderText}" FontSize="14"/>
                            <TextBlock Text="{Binding TotalUpload}" FontSize="24" FontWeight="SemiBold" 
                                       Foreground="{StaticResource UploadBrush}" Margin="0,8,0,0"/>
                        </StackPanel>
                    </Border>
                </Grid>

                <!-- Active Applications Card -->
                <Border Style="{StaticResource CardStyle}" 
                        Visibility="{Binding ActiveApps.Count, Converter={StaticResource CountToVisibilityConverter}, FallbackValue=Collapsed}">
                    <StackPanel>
                        <TextBlock Text="ðŸŸ¢ Active Applications" Style="{StaticResource SubHeaderText}" Margin="0,0,0,12"/>
                        
                        <ItemsControl ItemsSource="{Binding ActiveApps}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Background="{StaticResource SurfaceBrush}" 
                                            CornerRadius="6" 
                                            Padding="12,8" 
                                            Margin="0,0,0,8">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="32"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>

                                            <!-- Icon -->
                                            <Image Grid.Column="0" Source="{Binding Icon}" 
                                                   Width="24" Height="24" 
                                                   VerticalAlignment="Center"/>

                                            <!-- Name -->
                                            <StackPanel Grid.Column="1" VerticalAlignment="Center" Margin="8,0">
                                                <TextBlock Text="{Binding DisplayName}" 
                                                           Style="{StaticResource BodyText}"
                                                           Foreground="{StaticResource TextPrimaryBrush}"
                                                           FontWeight="Medium"/>
                                                <TextBlock Text="{Binding ProcessName}" 
                                                           Style="{StaticResource BodyText}"
                                                           FontSize="11"/>
                                            </StackPanel>

                                            <!-- Download Speed -->
                                            <StackPanel Grid.Column="2" Orientation="Horizontal" 
                                                        VerticalAlignment="Center" Margin="16,0">
                                                <TextBlock Text="â†“" Foreground="{StaticResource DownloadBrush}" 
                                                           FontSize="14" Margin="0,0,4,0"/>
                                                <TextBlock Text="{Binding DownloadSpeedBps, Converter={StaticResource SpeedFormatConverter}}" 
                                                           Foreground="{StaticResource DownloadBrush}"
                                                           FontWeight="Medium" Width="80"/>
                                            </StackPanel>

                                            <!-- Upload Speed -->
                                            <StackPanel Grid.Column="3" Orientation="Horizontal" 
                                                        VerticalAlignment="Center">
                                                <TextBlock Text="â†‘" Foreground="{StaticResource UploadBrush}" 
                                                           FontSize="14" Margin="0,0,4,0"/>
                                                <TextBlock Text="{Binding UploadSpeedBps, Converter={StaticResource SpeedFormatConverter}}" 
                                                           Foreground="{StaticResource UploadBrush}"
                                                           FontWeight="Medium" Width="80"/>
                                            </StackPanel>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </Border>

                <!-- Historical Usage Card -->
                <Border Style="{StaticResource CardStyle}">
                    <StackPanel>
                        <TextBlock Text="ðŸ“œ Historical Usage" Style="{StaticResource SubHeaderText}" Margin="0,0,0,12"/>
                        
                        <DataGrid ItemsSource="{Binding FilteredApps}"
                                  AutoGenerateColumns="False"
                                  IsReadOnly="True"
                                  CanUserAddRows="False"
                                  CanUserDeleteRows="False"
                                  HeadersVisibility="Column"
                                  GridLinesVisibility="Horizontal"
                                  Background="Transparent"
                                  RowBackground="{StaticResource SurfaceBrush}"
                                  AlternatingRowBackground="{StaticResource CardBrush}"
                                  BorderThickness="0"
                                  MaxHeight="400">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Application" 
                                                    Binding="{Binding AppName}" 
                                                    Width="*"
                                                    ElementStyle="{StaticResource DataGridCellText}"/>
                                <DataGridTextColumn Header="Process Name" 
                                                    Binding="{Binding ProcessName}" 
                                                    Width="150"
                                                    ElementStyle="{StaticResource DataGridCellText}"/>
                                <DataGridTextColumn Header="Download" 
                                                    Binding="{Binding BytesReceived, Converter={StaticResource ByteFormatConverter}}" 
                                                    Width="100"
                                                    ElementStyle="{StaticResource DataGridCellTextDownload}"/>
                                <DataGridTextColumn Header="Upload" 
                                                    Binding="{Binding BytesSent, Converter={StaticResource ByteFormatConverter}}" 
                                                    Width="100"
                                                    ElementStyle="{StaticResource DataGridCellTextUpload}"/>
                                <DataGridTextColumn Header="Total" 
                                                    Binding="{Binding TotalBytes, Converter={StaticResource ByteFormatConverter}}" 
                                                    Width="100"
                                                    ElementStyle="{StaticResource DataGridCellText}"/>
                                <DataGridTextColumn Header="Last Active" 
                                                    Binding="{Binding Timestamp, StringFormat={}{0:MMM dd, yyyy}}" 
                                                    Width="120"
                                                    ElementStyle="{StaticResource DataGridCellText}"/>
                            </DataGrid.Columns>
                        </DataGrid>

                        <!-- Empty State -->
                        <TextBlock Text="No application usage data found for the selected period."
                                   Style="{StaticResource BodyText}"
                                   HorizontalAlignment="Center"
                                   Margin="0,20"
                                   Visibility="{Binding FilteredApps.Count, Converter={StaticResource ZeroToVisibilityConverter}}"/>
                    </StackPanel>
                </Border>
            </StackPanel>
        </ScrollViewer>
    </Grid>
</UserControl>
