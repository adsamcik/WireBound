<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:WireBound.Avalonia.ViewModels"
             xmlns:models="using:WireBound.Core.Models"
             x:Class="WireBound.Avalonia.Views.ApplicationsView"
             x:DataType="vm:ApplicationsViewModel"
             Background="{StaticResource BackgroundBrush}"
             AutomationProperties.Name="Applications View">

    <Grid RowDefinitions="Auto, *">
        
        <!-- Loading Overlay -->
        <Border Grid.RowSpan="2"
                IsVisible="{Binding IsLoading}"
                Background="{StaticResource OverlayColor}"
                ZIndex="100">
            <Border Background="{StaticResource CardBrush}"
                    CornerRadius="16"
                    Padding="32"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center">
                <StackPanel Spacing="16">
                    <ProgressBar IsIndeterminate="True"
                                 IsVisible="{Binding IsLoading}"
                                 Width="48" Height="8"
                                 HorizontalAlignment="Center" />
                    <TextBlock Text="Loading applications..."
                               Classes="Subtitle"
                               HorizontalAlignment="Center" />
                </StackPanel>
            </Border>
        </Border>

        <ScrollViewer Grid.Row="1" Margin="28">
            <StackPanel Spacing="24">

                <!-- Page Header -->
                <StackPanel Spacing="4">
                    <TextBlock Text="Applications" Classes="PageTitle" />
                    <TextBlock Text="Per-application network usage tracking" Classes="Subtitle" />
                </StackPanel>

                <!-- Platform Warning -->
                <Border Classes="Card"
                        Background="{StaticResource WarningBannerColor}"
                        IsVisible="{Binding !IsPlatformSupported}">
                    <StackPanel Orientation="Horizontal" Spacing="16">
                        <Border Background="{StaticResource WarningBgTintBrush}" CornerRadius="10" Width="48" Height="48">
                            <TextBlock Text="âš ï¸" FontSize="24"
                                       HorizontalAlignment="Center" VerticalAlignment="Center" />
                        </Border>
                        <StackPanel VerticalAlignment="Center">
                            <TextBlock Text="Feature Not Available"
                                       FontSize="16" FontWeight="Bold"
                                       Foreground="{StaticResource WarningBrush}" />
                            <TextBlock Text="Per-app network tracking is not available on this platform."
                                       Classes="Subtitle" />
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- Feature Disabled Warning -->
                <Border Classes="Card"
                        Background="{StaticResource InfoBannerColor}"
                        IsVisible="{Binding !IsPerAppTrackingEnabled}">
                    <StackPanel Orientation="Horizontal" Spacing="16">
                        <Border Background="{StaticResource InfoBgTintBrush}" CornerRadius="10" Width="48" Height="48">
                            <TextBlock Text="â„¹ï¸" FontSize="24"
                                       HorizontalAlignment="Center" VerticalAlignment="Center" />
                        </Border>
                        <StackPanel VerticalAlignment="Center">
                            <TextBlock Text="Feature Disabled"
                                       FontSize="16" FontWeight="Bold"
                                       Foreground="{StaticResource PrimaryBrush}" />
                            <TextBlock Text="Enable Per-App Network Tracking in Settings to use this feature."
                                       Classes="Subtitle" />
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- Byte Tracking Preview Banner -->
                <Border Classes="Card"
                        Background="{StaticResource InfoBannerColor}"
                        IsVisible="{Binding IsByteTrackingLimited}">
                    <StackPanel Orientation="Horizontal" Spacing="16">
                        <Border Background="{StaticResource InfoBgTintBrush}" CornerRadius="10" Width="48" Height="48">
                            <TextBlock Text="ðŸ”¬" FontSize="24"
                                       HorizontalAlignment="Center" VerticalAlignment="Center" />
                        </Border>
                        <StackPanel VerticalAlignment="Center">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <TextBlock Text="Byte Tracking Preview"
                                           FontSize="16" FontWeight="Bold"
                                           Foreground="{StaticResource PrimaryBrush}" />
                                <Border Background="{StaticResource AccentBgTintBrush}" 
                                        CornerRadius="6" Padding="8,2">
                                    <TextBlock Text="LIMITED" FontSize="10" FontWeight="Bold"
                                               Foreground="{StaticResource PrimaryBrush}" />
                                </Border>
                            </StackPanel>
                            <TextBlock Text="Per-app byte counts are estimated. Accurate tracking requires starting the elevated helper."
                                       Classes="Subtitle" TextWrapping="Wrap" />
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- Summary Cards -->
                <Grid ColumnDefinitions="*, *, *">
                    <Border Grid.Column="0" Classes="ElevatedCard" Margin="0,0,10,0">
                        <StackPanel Spacing="8">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <TextBlock Text="ðŸ“±" FontSize="16" />
                                <TextBlock Text="APPS TRACKED" Classes="MetricLabel" />
                            </StackPanel>
                            <TextBlock Text="{Binding AppCount}"
                                       FontSize="32" FontWeight="Bold" />
                        </StackPanel>
                    </Border>
                    <Border Grid.Column="1" Classes="ElevatedCard" Margin="10,0">
                        <StackPanel Spacing="8">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <TextBlock Text="â¬‡ï¸" FontSize="16" />
                                <TextBlock Text="TOTAL DOWNLOAD" Classes="MetricLabel" />
                            </StackPanel>
                            <TextBlock Text="{Binding TotalDownload}"
                                       FontSize="32" FontWeight="Bold"
                                       Foreground="{StaticResource DownloadBrush}" />
                        </StackPanel>
                    </Border>
                    <Border Grid.Column="2" Classes="ElevatedCard" Margin="10,0,0,0">
                        <StackPanel Spacing="8">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <TextBlock Text="â¬†ï¸" FontSize="16" />
                                <TextBlock Text="TOTAL UPLOAD" Classes="MetricLabel" />
                            </StackPanel>
                            <TextBlock Text="{Binding TotalUpload}"
                                       FontSize="32" FontWeight="Bold"
                                       Foreground="{StaticResource UploadBrush}" />
                        </StackPanel>
                    </Border>
                </Grid>

                <!-- Filter Bar -->
                <Border Classes="Card" Padding="20">
                    <Grid ColumnDefinitions="*, Auto, Auto, Auto, Auto">
                        <Border Background="{StaticResource SurfaceBrush}"
                                Margin="0,0,16,0"
                                CornerRadius="10"
                                BorderBrush="{StaticResource GlassBorderBrush}"
                                BorderThickness="1"
                                Padding="12,0">
                            <TextBox Watermark="ðŸ” Search applications..."
                                     Text="{Binding SearchText}"
                                     Background="Transparent"
                                     BorderThickness="0"
                                     AutomationProperties.Name="Search Applications"
                                     AutomationProperties.HelpText="Filter applications by name" />
                        </Border>
                        <CalendarDatePicker Grid.Column="1"
                                            SelectedDate="{Binding StartDate}"
                                            Margin="0,0,16,0"
                                            AutomationProperties.Name="Start Date"
                                            AutomationProperties.HelpText="Select the start date for filtering application usage" />
                        <TextBlock Grid.Column="2" Text="â†’" VerticalAlignment="Center"
                                   Foreground="{StaticResource MutedTextBrush}"
                                   Margin="0,0,16,0" />
                        <CalendarDatePicker Grid.Column="3"
                                            SelectedDate="{Binding EndDate}"
                                            Margin="0,0,16,0"
                                            AutomationProperties.Name="End Date"
                                            AutomationProperties.HelpText="Select the end date for filtering application usage" />
                        <Button Grid.Column="4"
                                Content="ðŸ”„ Refresh"
                                Command="{Binding RefreshCommand}"
                                Classes="Primary"
                                Padding="16,10"
                                AutomationProperties.Name="Refresh Application Data"
                                AutomationProperties.HelpText="Reload application usage data for the selected date range" />
                    </Grid>
                </Border>

                <!-- Historical Usage -->
                <StackPanel Spacing="16">
                    <StackPanel Orientation="Horizontal" Spacing="12">
                        <TextBlock Text="ðŸ“Š" FontSize="16" VerticalAlignment="Center" />
                        <TextBlock Text="HISTORICAL USAGE" Classes="MetricLabel" VerticalAlignment="Center" />
                    </StackPanel>
                    
                    <Border Classes="Card">
                        <ListBox ItemsSource="{Binding AllApps}"
                                 MaxHeight="600"
                                 Background="Transparent"
                                 BorderThickness="0"
                                 AutomationProperties.Name="Application Usage List"
                                 AutomationProperties.HelpText="List of applications with their network usage statistics">
                            <ListBox.Styles>
                                <Style Selector="ListBoxItem">
                                    <Setter Property="Padding" Value="0"/>
                                    <Setter Property="Margin" Value="0"/>
                                    <Setter Property="Background" Value="Transparent"/>
                                </Style>
                                <Style Selector="ListBoxItem:selected /template/ ContentPresenter#PART_ContentPresenter">
                                    <Setter Property="Background" Value="Transparent"/>
                                </Style>
                            </ListBox.Styles>
                            <ListBox.ItemTemplate>
                                <DataTemplate x:DataType="models:AppUsageRecord">
                                    <Border Padding="16" Margin="0,0,0,8"
                                            Background="{StaticResource BorderSubtleBrush}"
                                            CornerRadius="12">
                                        <Grid ColumnDefinitions="Auto, *, Auto, Auto, Auto">
                                            <Border Width="48" Height="48"
                                                    Background="{StaticResource AccentBgTintBrush}"
                                                    CornerRadius="12"
                                                    Margin="0,0,20,0">
                                                <TextBlock Text="ðŸ“¦" FontSize="22"
                                                           HorizontalAlignment="Center"
                                                           VerticalAlignment="Center" />
                                            </Border>
                                            <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="2"
                                                        Margin="0,0,20,0">
                                                <TextBlock Text="{Binding AppName}"
                                                           FontSize="15" FontWeight="Bold"
                                                           TextTrimming="CharacterEllipsis" />
                                                <TextBlock Text="{Binding ProcessName}" Classes="Caption" />
                                            </StackPanel>
                                            <StackPanel Grid.Column="2" VerticalAlignment="Center" Spacing="2">
                                                <TextBlock Text="Download" Classes="Caption" HorizontalAlignment="Right" />
                                                <TextBlock Text="{Binding BytesReceived, StringFormat='{}{0:N0} B'}"
                                                           FontSize="14" FontWeight="Bold"
                                                           Foreground="{StaticResource DownloadBrush}"
                                                           HorizontalAlignment="Right" />
                                            </StackPanel>
                                            <StackPanel Grid.Column="3" VerticalAlignment="Center" Spacing="2">
                                                <TextBlock Text="Upload" Classes="Caption" HorizontalAlignment="Right" />
                                                <TextBlock Text="{Binding BytesSent, StringFormat='{}{0:N0} B'}"
                                                           FontSize="14" FontWeight="Bold"
                                                           Foreground="{StaticResource UploadBrush}"
                                                           HorizontalAlignment="Right" />
                                            </StackPanel>
                                            <StackPanel Grid.Column="4" VerticalAlignment="Center" Spacing="2">
                                                <TextBlock Text="Total" Classes="Caption" HorizontalAlignment="Right" />
                                                <TextBlock Text="{Binding TotalBytes, StringFormat='{}{0:N0} B'}"
                                                           FontSize="14" FontWeight="Bold"
                                                           HorizontalAlignment="Right" />
                                            </StackPanel>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </Border>

                    <!-- Empty State -->
                    <Border Background="{StaticResource BorderSubtleBrush}"
                            CornerRadius="12"
                            Padding="40"
                            Margin="0,8"
                            IsVisible="{Binding !AllApps.Count}">
                        <StackPanel HorizontalAlignment="Center" Spacing="12">
                            <TextBlock Text="ðŸ“¦" FontSize="36" HorizontalAlignment="Center" />
                            <TextBlock Text="No application data found"
                                       FontSize="16" FontWeight="Bold"
                                       HorizontalAlignment="Center" />
                            <TextBlock Text="for the selected date range"
                                       Classes="Subtitle"
                                       HorizontalAlignment="Center" />
                        </StackPanel>
                    </Border>
                </StackPanel>

            </StackPanel>
        </ScrollViewer>
    </Grid>
</UserControl>
