<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:WireBound.Avalonia.ViewModels"
             xmlns:conv="using:WireBound.Avalonia.Converters"
             xmlns:lvc="using:LiveChartsCore.SkiaSharpView.Avalonia"
             x:Class="WireBound.Avalonia.Views.HistoryView"
             x:DataType="vm:HistoryViewModel"
             Background="{DynamicResource BackgroundBrush}">

    <Grid RowDefinitions="Auto, Auto, Auto, Auto, *" Margin="28">
        
        <!-- HEADER ROW -->
        <Grid ColumnDefinitions="*, Auto">
            <StackPanel Spacing="4">
                <TextBlock Text="History" Classes="PageTitle" />
                <TextBlock Text="Network usage over time" Classes="Subtitle" />
            </StackPanel>
            
            <!-- Controls: Period Selector + Custom Range + Export -->
            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="12" VerticalAlignment="Center">
                
                <!-- Period Selector -->
                <Border Classes="CompactCard" Padding="14,10">
                    <StackPanel Orientation="Horizontal" Spacing="12">
                        <TextBlock Text="üìÖ" FontSize="16" VerticalAlignment="Center" />
                        <TextBlock Text="Period" Classes="Caption" VerticalAlignment="Center" />
                        <ComboBox ItemsSource="{Binding PeriodOptions}"
                                  SelectedItem="{Binding SelectedPeriod}"
                                  Width="110"
                                  VerticalAlignment="Center">
                            <ComboBox.ItemTemplate>
                                <DataTemplate x:DataType="vm:HistoryPeriodOption">
                                    <TextBlock Text="{Binding Label}" />
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>
                    </StackPanel>
                </Border>

                <!-- Custom Date Range Picker (visible when Custom is selected) -->
                <Border Classes="CompactCard" Padding="14,10"
                        IsVisible="{Binding IsCustomDateRange}">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="From" Classes="Caption" VerticalAlignment="Center" />
                        <CalendarDatePicker SelectedDate="{Binding CustomStartDate}"
                                            DisplayDateEnd="{Binding CustomEndDate.DateTime}"
                                            Width="130" />
                        <TextBlock Text="To" Classes="Caption" VerticalAlignment="Center" />
                        <CalendarDatePicker SelectedDate="{Binding CustomEndDate}"
                                            DisplayDateStart="{Binding CustomStartDate.DateTime}"
                                            Width="130" />
                    </StackPanel>
                </Border>

                <!-- Data Cap Toggle -->
                <Border Classes="CompactCard" Padding="10,8">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="üìä" FontSize="14" VerticalAlignment="Center" />
                        <TextBlock Text="Cap" Classes="Caption" VerticalAlignment="Center" />
                        <ToggleSwitch IsChecked="{Binding HasDataCap}" 
                                      OnContent="" OffContent=""
                                      Padding="0" Margin="0" />
                    </StackPanel>
                </Border>
                
                <!-- Export Button with Status -->
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <Button Command="{Binding ExportToCsvCommand}"
                            IsEnabled="{Binding !IsExporting}"
                            ToolTip.Tip="Export to CSV"
                            Padding="12,10">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <!-- Spinner when exporting -->
                            <Border IsVisible="{Binding IsExporting}" 
                                    Width="14" Height="14"
                                    CornerRadius="7"
                                    BorderBrush="{DynamicResource PrimaryBrush}"
                                    BorderThickness="2">
                                <Border.RenderTransform>
                                    <RotateTransform />
                                </Border.RenderTransform>
                                <Border.Styles>
                                    <Style Selector="Border">
                                        <Style.Animations>
                                            <Animation Duration="0:0:1" IterationCount="Infinite">
                                                <KeyFrame Cue="0%">
                                                    <Setter Property="RenderTransform" Value="rotate(0deg)" />
                                                </KeyFrame>
                                                <KeyFrame Cue="100%">
                                                    <Setter Property="RenderTransform" Value="rotate(360deg)" />
                                                </KeyFrame>
                                            </Animation>
                                        </Style.Animations>
                                    </Style>
                                </Border.Styles>
                            </Border>
                            <!-- Success checkmark -->
                            <TextBlock Text="‚úì" FontSize="14" 
                                       Foreground="{DynamicResource SuccessBrush}"
                                       IsVisible="{Binding ExportSuccess}" />
                            <!-- Normal icon -->
                            <TextBlock Text="üì•" FontSize="14" 
                                       IsVisible="{Binding !IsExporting}" />
                            <TextBlock Text="Export" FontSize="13" />
                        </StackPanel>
                    </Button>
                    
                    <!-- Export Status Message -->
                    <TextBlock Text="{Binding ExportStatusMessage}"
                               FontSize="12"
                               VerticalAlignment="Center"
                               Foreground="{DynamicResource SecondaryTextBrush}"
                               IsVisible="{Binding ExportStatusMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />
                </StackPanel>
            </StackPanel>
        </Grid>

        <!-- LOADING OVERLAY -->
        <Border Grid.Row="1" Grid.RowSpan="4"
                Background="#80000000"
                CornerRadius="12"
                Margin="0,20,0,0"
                IsVisible="{Binding IsLoading}"
                ZIndex="100">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="16">
                <Border Width="48" Height="48"
                        CornerRadius="24"
                        BorderBrush="{DynamicResource PrimaryBrush}"
                        BorderThickness="3">
                    <Border.RenderTransform>
                        <RotateTransform />
                    </Border.RenderTransform>
                    <Border.Styles>
                        <Style Selector="Border">
                            <Style.Animations>
                                <Animation Duration="0:0:1" IterationCount="Infinite">
                                    <KeyFrame Cue="0%">
                                        <Setter Property="RenderTransform" Value="rotate(0deg)" />
                                    </KeyFrame>
                                    <KeyFrame Cue="100%">
                                        <Setter Property="RenderTransform" Value="rotate(360deg)" />
                                    </KeyFrame>
                                </Animation>
                            </Style.Animations>
                        </Style>
                    </Border.Styles>
                </Border>
                <TextBlock Text="Loading history data..."
                           FontSize="14"
                           Foreground="{DynamicResource SecondaryTextBrush}" />
            </StackPanel>
        </Border>

        <!-- ERROR BANNER -->
        <Border Grid.Row="1"
                Background="{DynamicResource ErrorBannerColor}"
                CornerRadius="12"
                Padding="20"
                Margin="0,20,0,0"
                IsVisible="{Binding HasError}">
            <Grid ColumnDefinitions="Auto, *, Auto">
                <Border Background="#30F45B69" CornerRadius="8" Width="40" Height="40">
                    <TextBlock Text="‚ö†Ô∏è" FontSize="20"
                               HorizontalAlignment="Center" VerticalAlignment="Center" />
                </Border>
                <StackPanel Grid.Column="1" Margin="16,0" VerticalAlignment="Center">
                    <TextBlock Text="Unable to load history data"
                               FontSize="16" FontWeight="Bold"
                               Foreground="{DynamicResource ErrorBrush}" />
                    <TextBlock Text="{Binding ErrorMessage}"
                               FontSize="13"
                               Foreground="{DynamicResource SecondaryTextBrush}"
                               TextWrapping="Wrap" />
                </StackPanel>
                <Button Grid.Column="2"
                        Command="{Binding RetryCommand}"
                        Padding="16,10"
                        VerticalAlignment="Center">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <TextBlock Text="üîÑ" FontSize="14" />
                        <TextBlock Text="Retry" FontSize="13" />
                    </StackPanel>
                </Button>
            </Grid>
        </Border>

        <!-- SUMMARY STATISTICS ROW - Responsive WrapPanel -->
        <Border Grid.Row="1" Classes="Card" Padding="16" Margin="0,20,0,0"
                IsVisible="{Binding HasData}">
            <WrapPanel Orientation="Horizontal" HorizontalAlignment="Center">
                
                <!-- Total Download -->
                <Border Background="{DynamicResource BorderSubtleBrush}" CornerRadius="12" Padding="16,12" Margin="4" MinWidth="140">
                    <StackPanel HorizontalAlignment="Center" Spacing="6">
                        <StackPanel Orientation="Horizontal" Spacing="6" HorizontalAlignment="Center">
                            <TextBlock Text="‚¨áÔ∏è" FontSize="12" />
                            <TextBlock Text="DOWNLOADED" Classes="MetricLabel" />
                        </StackPanel>
                        <TextBlock Text="{Binding TotalDownload}"
                                   FontSize="20" FontWeight="Bold"
                                   Foreground="{DynamicResource DownloadBrush}"
                                   HorizontalAlignment="Center" />
                    </StackPanel>
                </Border>
                
                <!-- Total Upload -->
                <Border Background="{DynamicResource BorderSubtleBrush}" CornerRadius="12" Padding="16,12" Margin="4" MinWidth="140">
                    <StackPanel HorizontalAlignment="Center" Spacing="6">
                        <StackPanel Orientation="Horizontal" Spacing="6" HorizontalAlignment="Center">
                            <TextBlock Text="‚¨ÜÔ∏è" FontSize="12" />
                            <TextBlock Text="UPLOADED" Classes="MetricLabel" />
                        </StackPanel>
                        <TextBlock Text="{Binding TotalUpload}"
                                   FontSize="20" FontWeight="Bold"
                                   Foreground="{DynamicResource UploadBrush}"
                                   HorizontalAlignment="Center" />
                    </StackPanel>
                </Border>
                
                <!-- Total Usage -->
                <Border Background="{DynamicResource BorderSubtleBrush}" CornerRadius="12" Padding="16,12" Margin="4" MinWidth="140">
                    <StackPanel HorizontalAlignment="Center" Spacing="6">
                        <StackPanel Orientation="Horizontal" Spacing="6" HorizontalAlignment="Center">
                            <TextBlock Text="üìä" FontSize="12" />
                            <TextBlock Text="TOTAL" Classes="MetricLabel" />
                        </StackPanel>
                        <TextBlock Text="{Binding TotalUsage}"
                                   FontSize="20" FontWeight="Bold"
                                   Foreground="{DynamicResource PrimaryTextBrush}"
                                   HorizontalAlignment="Center" />
                    </StackPanel>
                </Border>
                
                <!-- Daily Average -->
                <Border Background="{DynamicResource BorderSubtleBrush}" CornerRadius="12" Padding="16,12" Margin="4" MinWidth="140">
                    <StackPanel HorizontalAlignment="Center" Spacing="6">
                        <StackPanel Orientation="Horizontal" Spacing="6" HorizontalAlignment="Center">
                            <TextBlock Text="üìà" FontSize="12" />
                            <TextBlock Text="DAILY AVG" Classes="MetricLabel" />
                        </StackPanel>
                        <TextBlock Text="{Binding DailyAverage}"
                                   FontSize="20" FontWeight="Bold"
                                   Foreground="{DynamicResource SecondaryTextBrush}"
                                   HorizontalAlignment="Center" />
                    </StackPanel>
                </Border>
                
                <!-- Peak Day -->
                <Border Background="{DynamicResource BorderSubtleBrush}" CornerRadius="12" Padding="16,12" Margin="4" MinWidth="140">
                    <StackPanel HorizontalAlignment="Center" Spacing="6">
                        <StackPanel Orientation="Horizontal" Spacing="6" HorizontalAlignment="Center">
                            <TextBlock Text="üî•" FontSize="12" />
                            <TextBlock Text="PEAK DAY" Classes="MetricLabel" />
                        </StackPanel>
                        <TextBlock Text="{Binding PeakDayUsage}"
                                   FontSize="20" FontWeight="Bold"
                                   Foreground="{DynamicResource WarningBrush}"
                                   HorizontalAlignment="Center" />
                        <TextBlock Text="{Binding PeakDayDate}"
                                   Classes="Caption"
                                   HorizontalAlignment="Center" />
                    </StackPanel>
                </Border>
                
                <!-- Trend vs Previous Period -->
                <Border Background="{DynamicResource BorderSubtleBrush}" CornerRadius="12" Padding="16,12" Margin="4" MinWidth="140">
                    <StackPanel HorizontalAlignment="Center" Spacing="6">
                        <StackPanel Orientation="Horizontal" Spacing="6" HorizontalAlignment="Center">
                            <TextBlock Text="üìâ" FontSize="12" />
                            <TextBlock Text="VS PREVIOUS" Classes="MetricLabel" />
                        </StackPanel>
                        <TextBlock Text="{Binding TrendVsPreviousPeriod}"
                                   FontSize="20" FontWeight="Bold"
                                   Foreground="{DynamicResource SecondaryTextBrush}"
                                   HorizontalAlignment="Center" />
                    </StackPanel>
                </Border>
            </WrapPanel>
        </Border>

        <!-- DATA CAP VISUALIZATION (only shown when enabled) -->
        <Border Grid.Row="2" Classes="Card" Padding="20" Margin="0,12,0,0"
                IsVisible="{Binding HasDataCap}">
            <Grid ColumnDefinitions="Auto, *, Auto" RowDefinitions="Auto, Auto">
                <!-- Icon and Title -->
                <Border Background="#15FFB627" CornerRadius="8" Width="44" Height="44" 
                        Grid.RowSpan="2" VerticalAlignment="Center">
                    <TextBlock Text="üìä" FontSize="22"
                               HorizontalAlignment="Center" VerticalAlignment="Center" />
                </Border>
                
                <!-- Progress Section -->
                <StackPanel Grid.Column="1" Margin="16,0" Spacing="8">
                    <Grid ColumnDefinitions="*, Auto">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <TextBlock Text="Data Cap" FontSize="14" FontWeight="Bold" />
                            <TextBlock FontSize="12" VerticalAlignment="Center"
                                       Foreground="{DynamicResource WarningBrush}"
                                       IsVisible="{Binding DataCapWarning}">
                                ‚ö†Ô∏è 80% used
                            </TextBlock>
                            <TextBlock FontSize="12" VerticalAlignment="Center"
                                       Foreground="{DynamicResource ErrorBrush}"
                                       IsVisible="{Binding DataCapCritical}">
                                üö® Almost exceeded!
                            </TextBlock>
                        </StackPanel>
                        <TextBlock Grid.Column="1" FontSize="12"
                                   Foreground="{DynamicResource SecondaryTextBrush}">
                            <Run Text="{Binding DataCapUsedFormatted}" />
                            <Run Text=" of " />
                            <Run Text="{Binding DataCapTotalFormatted}" />
                        </TextBlock>
                    </Grid>
                    
                    <!-- Progress Bar -->
                    <Grid Height="12">
                        <!-- Background track -->
                        <Border Background="{DynamicResource BorderSubtleBrush}" 
                                CornerRadius="6" />
                        <!-- Filled progress - use a nested grid with star sizing -->
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="{Binding DataCapUsedPercent, Converter={x:Static conv:PercentToGridLengthConverter.Instance}}" />
                                <ColumnDefinition Width="{Binding DataCapUsedPercent, Converter={x:Static conv:PercentToRemainingGridLengthConverter.Instance}}" />
                            </Grid.ColumnDefinitions>
                            <Border CornerRadius="6">
                                <Border.Background>
                                    <LinearGradientBrush StartPoint="0%,50%" EndPoint="100%,50%">
                                        <GradientStop Color="#00E5FF" Offset="0" />
                                        <GradientStop Color="#00C9A7" Offset="1" />
                                    </LinearGradientBrush>
                                </Border.Background>
                            </Border>
                        </Grid>
                        <!-- Warning zone marker at 80% using proportional grid -->
                        <Grid ColumnDefinitions="4*,Auto,*">
                            <Border Grid.Column="1" Width="2" Height="12" 
                                    Background="{DynamicResource WarningBrush}"
                                    Opacity="0.5" />
                        </Grid>
                    </Grid>
                </StackPanel>
                
                <!-- Remaining -->
                <StackPanel Grid.Column="2" HorizontalAlignment="Right" VerticalAlignment="Center">
                    <TextBlock Text="Remaining" Classes="Caption" HorizontalAlignment="Right" />
                    <TextBlock Text="{Binding DataCapRemainingFormatted}"
                               FontSize="16" FontWeight="Bold"
                               Foreground="{DynamicResource SuccessBrush}"
                               HorizontalAlignment="Right" />
                </StackPanel>
                
                <!-- Cap Size Selector -->
                <StackPanel Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="2"
                            Orientation="Horizontal" Spacing="8" Margin="16,12,0,0">
                    <TextBlock Text="Set cap:" Classes="Caption" VerticalAlignment="Center" />
                    <Button Command="{Binding SetDataCapCommand}" CommandParameter="50" 
                            Content="50 GB" Padding="10,6" FontSize="11" />
                    <Button Command="{Binding SetDataCapCommand}" CommandParameter="100"
                            Content="100 GB" Padding="10,6" FontSize="11" />
                    <Button Command="{Binding SetDataCapCommand}" CommandParameter="250"
                            Content="250 GB" Padding="10,6" FontSize="11" />
                    <Button Command="{Binding SetDataCapCommand}" CommandParameter="500"
                            Content="500 GB" Padding="10,6" FontSize="11" />
                    <Button Command="{Binding SetDataCapCommand}" CommandParameter="1000"
                            Content="1 TB" Padding="10,6" FontSize="11" />
                </StackPanel>
            </Grid>
        </Border>

        <!-- USAGE CHART -->
        <Border Grid.Row="3" Classes="ElevatedCard" Margin="0,20,0,0" Height="220"
                IsVisible="{Binding HasData}">
            <Grid RowDefinitions="Auto, *">
                
                <!-- Chart Header with Legend -->
                <Grid ColumnDefinitions="Auto, *, Auto" Margin="0,0,0,12">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <Border Background="#15FFB627" CornerRadius="8" Width="36" Height="36">
                            <TextBlock Text="üìä" FontSize="18"
                                       HorizontalAlignment="Center" VerticalAlignment="Center" />
                        </Border>
                        <StackPanel VerticalAlignment="Center">
                            <TextBlock Text="Daily Usage" Classes="CardTitle" />
                            <TextBlock Text="Click a day to see hourly breakdown" Classes="Caption" />
                        </StackPanel>
                    </StackPanel>
                    
                    <!-- Legend -->
                    <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="20" VerticalAlignment="Center">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <Border Background="{DynamicResource DownloadBrush}"
                                    Width="16" Height="4"
                                    CornerRadius="2"
                                    VerticalAlignment="Center" />
                            <TextBlock Text="Download" FontSize="12" VerticalAlignment="Center" />
                        </StackPanel>
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <Border Background="{DynamicResource UploadBrush}"
                                    Width="16" Height="4"
                                    CornerRadius="2"
                                    VerticalAlignment="Center" />
                            <TextBlock Text="Upload" FontSize="12" VerticalAlignment="Center" />
                        </StackPanel>
                    </StackPanel>
                </Grid>
                
                <!-- Chart -->
                <lvc:CartesianChart Grid.Row="1"
                                    Series="{Binding UsageSeries}"
                                    XAxes="{Binding XAxes}"
                                    YAxes="{Binding YAxes}"
                                    TooltipPosition="Top"
                                    Background="Transparent" />
            </Grid>
        </Border>

        <!-- MAIN CONTENT: Table + Hourly Panel -->
        <Grid Grid.Row="4" Margin="0,20,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>
            
            <!-- Daily Usage Table -->
            <Border Classes="ElevatedCard">
                <Grid RowDefinitions="Auto, Auto, *">
                    
                    <!-- Section Header -->
                    <StackPanel Orientation="Horizontal" Spacing="12">
                        <Border Background="#15FFB627" CornerRadius="8" Width="40" Height="40">
                            <TextBlock Text="üìÖ" FontSize="20"
                                       HorizontalAlignment="Center" VerticalAlignment="Center" />
                        </Border>
                        <StackPanel VerticalAlignment="Center">
                            <TextBlock Text="Daily Breakdown" Classes="SectionHeader" />
                            <TextBlock Classes="Caption">
                                <Run Text="{Binding SelectedPeriod.Description}" />
                                <Run Text=" ‚Ä¢ Click row for hourly details" />
                            </TextBlock>
                        </StackPanel>
                    </StackPanel>
                    
                    <!-- Table Header with Sortable Columns -->
                    <Border Grid.Row="1"
                            Background="{DynamicResource BorderSubtleBrush}"
                            CornerRadius="8"
                            Padding="16,12"
                            Margin="0,16,0,0">
                        <Grid ColumnDefinitions="1.2*, *, *, *, 0.5*, 0.3*">
                            <!-- Date Column - Sortable -->
                            <Button Command="{Binding SortByCommand}" CommandParameter="Date"
                                    Background="Transparent" Padding="0" Cursor="Hand"
                                    HorizontalAlignment="Left">
                                <StackPanel Orientation="Horizontal" Spacing="4">
                                    <TextBlock Text="DATE" Classes="MetricLabel" FontWeight="Bold" />
                                    <TextBlock FontSize="10" Foreground="{DynamicResource PrimaryBrush}" VerticalAlignment="Center">
                                        <TextBlock.Text>
                                            <MultiBinding Converter="{x:Static conv:SortDirectionConverter.Instance}" ConverterParameter="Date">
                                                <Binding Path="SortColumn" />
                                                <Binding Path="SortAscending" />
                                            </MultiBinding>
                                        </TextBlock.Text>
                                    </TextBlock>
                                </StackPanel>
                            </Button>
                            
                            <!-- Downloaded Column - Sortable -->
                            <Button Grid.Column="1" Command="{Binding SortByCommand}" CommandParameter="Download"
                                    Background="Transparent" Padding="0" Cursor="Hand"
                                    HorizontalAlignment="Left">
                                <StackPanel Orientation="Horizontal" Spacing="4">
                                    <TextBlock Text="DOWNLOADED" Classes="MetricLabel" FontWeight="Bold" />
                                    <TextBlock FontSize="10" Foreground="{DynamicResource PrimaryBrush}" VerticalAlignment="Center">
                                        <TextBlock.Text>
                                            <MultiBinding Converter="{x:Static conv:SortDirectionConverter.Instance}" ConverterParameter="Download">
                                                <Binding Path="SortColumn" />
                                                <Binding Path="SortAscending" />
                                            </MultiBinding>
                                        </TextBlock.Text>
                                    </TextBlock>
                                </StackPanel>
                            </Button>
                            
                            <!-- Uploaded Column - Sortable -->
                            <Button Grid.Column="2" Command="{Binding SortByCommand}" CommandParameter="Upload"
                                    Background="Transparent" Padding="0" Cursor="Hand"
                                    HorizontalAlignment="Left">
                                <StackPanel Orientation="Horizontal" Spacing="4">
                                    <TextBlock Text="UPLOADED" Classes="MetricLabel" FontWeight="Bold" />
                                    <TextBlock FontSize="10" Foreground="{DynamicResource PrimaryBrush}" VerticalAlignment="Center">
                                        <TextBlock.Text>
                                            <MultiBinding Converter="{x:Static conv:SortDirectionConverter.Instance}" ConverterParameter="Upload">
                                                <Binding Path="SortColumn" />
                                                <Binding Path="SortAscending" />
                                            </MultiBinding>
                                        </TextBlock.Text>
                                    </TextBlock>
                                </StackPanel>
                            </Button>
                            
                            <!-- Total Column - Sortable -->
                            <Button Grid.Column="3" Command="{Binding SortByCommand}" CommandParameter="Total"
                                    Background="Transparent" Padding="0" Cursor="Hand"
                                    HorizontalAlignment="Left">
                                <StackPanel Orientation="Horizontal" Spacing="4">
                                    <TextBlock Text="TOTAL" Classes="MetricLabel" FontWeight="Bold" />
                                    <TextBlock FontSize="10" Foreground="{DynamicResource PrimaryBrush}" VerticalAlignment="Center">
                                        <TextBlock.Text>
                                            <MultiBinding Converter="{x:Static conv:SortDirectionConverter.Instance}" ConverterParameter="Total">
                                                <Binding Path="SortColumn" />
                                                <Binding Path="SortAscending" />
                                            </MultiBinding>
                                        </TextBlock.Text>
                                    </TextBlock>
                                </StackPanel>
                            </Button>
                            
                            <TextBlock Grid.Column="4" Text="TREND" Classes="MetricLabel" FontWeight="Bold" HorizontalAlignment="Center" />
                            <!-- Empty column for chevron -->
                        </Grid>
                    </Border>
                    
                    <!-- Data List -->
                    <ScrollViewer Grid.Row="2" Margin="0,8,0,0">
                        <ItemsControl ItemsSource="{Binding DailyUsages}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="vm:DailyUsageItem">
                                    <Button Command="{Binding $parent[ItemsControl].((vm:HistoryViewModel)DataContext).SelectDayCommand}"
                                            CommandParameter="{Binding}"
                                            Background="Transparent"
                                            Padding="0"
                                            HorizontalAlignment="Stretch"
                                            HorizontalContentAlignment="Stretch"
                                            Cursor="Hand">
                                        <Button.Styles>
                                            <Style Selector="Button:pointerover /template/ ContentPresenter">
                                                <Setter Property="Background" Value="{DynamicResource FlyoutItemHoverColor}" />
                                            </Style>
                                        </Button.Styles>
                                        <Border CornerRadius="8"
                                                Padding="16,14"
                                                Margin="0,2"
                                                BorderThickness="2">
                                            <Border.BorderBrush>
                                                <MultiBinding Converter="{x:Static conv:SelectedRowBorderConverter.Instance}">
                                                    <Binding Path="Date" />
                                                    <Binding Path="$parent[ItemsControl].((vm:HistoryViewModel)DataContext).SelectedDate" />
                                                </MultiBinding>
                                            </Border.BorderBrush>
                                            <Border.Background>
                                                <MultiBinding Converter="{x:Static conv:SelectedRowBackgroundConverter.Instance}">
                                                    <Binding Path="Date" />
                                                    <Binding Path="$parent[ItemsControl].((vm:HistoryViewModel)DataContext).SelectedDate" />
                                                </MultiBinding>
                                            </Border.Background>
                                            <Grid ColumnDefinitions="1.2*, *, *, *, 0.5*, 0.3*">
                                                <TextBlock Text="{Binding DateFormatted}"
                                                           FontSize="14" FontWeight="Bold" />
                                                <TextBlock Grid.Column="1"
                                                           Text="{Binding DownloadFormatted}"
                                                           FontSize="14"
                                                           Foreground="{DynamicResource DownloadBrush}" />
                                                <TextBlock Grid.Column="2"
                                                           Text="{Binding UploadFormatted}"
                                                           FontSize="14"
                                                           Foreground="{DynamicResource UploadBrush}" />
                                                <TextBlock Grid.Column="3"
                                                           Text="{Binding TotalFormatted}"
                                                           FontSize="14" FontWeight="Bold" />
                                                <TextBlock Grid.Column="4"
                                                           Text="{Binding TrendIndicator}"
                                                           FontSize="16" FontWeight="Bold"
                                                           HorizontalAlignment="Center"
                                                           ToolTip.Tip="{Binding TrendTooltip}" />
                                                <!-- Row expansion chevron -->
                                                <TextBlock Grid.Column="5"
                                                           Text="‚Ä∫"
                                                           FontSize="18"
                                                           Foreground="{DynamicResource SecondaryTextBrush}"
                                                           HorizontalAlignment="Right"
                                                           VerticalAlignment="Center"
                                                           RenderTransformOrigin="0.5,0.5">
                                                    <TextBlock.Opacity>
                                                        <MultiBinding Converter="{x:Static conv:SelectedRowChevronOpacityConverter.Instance}">
                                                            <Binding Path="Date" />
                                                            <Binding Path="$parent[ItemsControl].((vm:HistoryViewModel)DataContext).SelectedDate" />
                                                        </MultiBinding>
                                                    </TextBlock.Opacity>
                                                    <TextBlock.RenderTransform>
                                                        <RotateTransform>
                                                            <RotateTransform.Angle>
                                                                <MultiBinding Converter="{x:Static conv:SelectedRowChevronRotationConverter.Instance}">
                                                                    <Binding Path="Date" />
                                                                    <Binding Path="$parent[ItemsControl].((vm:HistoryViewModel)DataContext).SelectedDate" />
                                                                </MultiBinding>
                                                            </RotateTransform.Angle>
                                                        </RotateTransform>
                                                    </TextBlock.RenderTransform>
                                                </TextBlock>
                                            </Grid>
                                        </Border>
                                    </Button>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                    
                    <!-- Empty State -->
                    <Border Grid.Row="2"
                            Background="{DynamicResource BorderSubtleBrush}"
                            CornerRadius="12"
                            Padding="40"
                            Margin="0,20"
                            IsVisible="{Binding !HasData}">
                        <StackPanel HorizontalAlignment="Center" Spacing="12">
                            <Border Background="{DynamicResource SurfaceBrush}"
                                    CornerRadius="20"
                                    Width="80" Height="80">
                                <TextBlock Text="üìä" FontSize="36"
                                           HorizontalAlignment="Center" VerticalAlignment="Center" />
                            </Border>
                            <TextBlock Text="No history data yet"
                                       FontSize="18" FontWeight="Bold"
                                       HorizontalAlignment="Center" />
                            <TextBlock Text="Data will appear after monitoring runs for a while"
                                       Classes="Subtitle"
                                       HorizontalAlignment="Center" />
                        </StackPanel>
                    </Border>
                </Grid>
            </Border>
            
            <!-- Hourly Drill-Down Panel with Slide Animation -->
            <Border Grid.Column="1" 
                    Classes="ElevatedCard"
                    Width="400"
                    Margin="20,0,0,0"
                    IsVisible="{Binding ShowHourlyPanel}"
                    ClipToBounds="True">
                <Border.RenderTransform>
                    <TranslateTransform />
                </Border.RenderTransform>
                <Border.Styles>
                    <Style Selector="Border">
                        <Setter Property="Opacity" Value="0" />
                        <Setter Property="RenderTransform">
                            <Setter.Value>
                                <TranslateTransform X="50" />
                            </Setter.Value>
                        </Setter>
                    </Style>
                    <Style Selector="Border[IsVisible=True]">
                        <Style.Animations>
                            <Animation Duration="0:0:0.25" Easing="CubicEaseOut" FillMode="Forward">
                                <KeyFrame Cue="0%">
                                    <Setter Property="Opacity" Value="0" />
                                    <Setter Property="RenderTransform">
                                        <Setter.Value>
                                            <TranslateTransform X="50" />
                                        </Setter.Value>
                                    </Setter>
                                </KeyFrame>
                                <KeyFrame Cue="100%">
                                    <Setter Property="Opacity" Value="1" />
                                    <Setter Property="RenderTransform">
                                        <Setter.Value>
                                            <TranslateTransform X="0" />
                                        </Setter.Value>
                                    </Setter>
                                </KeyFrame>
                            </Animation>
                        </Style.Animations>
                    </Style>
                </Border.Styles>
                <Grid RowDefinitions="Auto, Auto, *, Auto">
                    
                    <!-- Panel Header -->
                    <Grid ColumnDefinitions="*, Auto">
                        <StackPanel Orientation="Horizontal" Spacing="10">
                            <Border Background="#1500E5FF" CornerRadius="8" Width="36" Height="36">
                                <TextBlock Text="‚è∞" FontSize="18"
                                           HorizontalAlignment="Center" VerticalAlignment="Center" />
                            </Border>
                            <StackPanel VerticalAlignment="Center">
                                <TextBlock Text="Hourly Breakdown" Classes="CardTitle" />
                                <TextBlock Text="{Binding SelectedDay.DateFormatted}" Classes="Caption" />
                            </StackPanel>
                        </StackPanel>
                        
                        <Button Grid.Column="1"
                                Command="{Binding CloseHourlyPanelCommand}"
                                Padding="8"
                                ToolTip.Tip="Close panel">
                            <TextBlock Text="‚úï" FontSize="14" />
                        </Button>
                    </Grid>
                    
                    <!-- Hourly Chart -->
                    <Border Grid.Row="1" Height="140" Margin="0,16,0,0">
                        <lvc:CartesianChart Series="{Binding HourlySeries}"
                                            XAxes="{Binding HourlyXAxes}"
                                            YAxes="{Binding HourlyYAxes}"
                                            TooltipPosition="Top"
                                            Background="Transparent" />
                    </Border>
                    
                    <!-- Hourly Data List -->
                    <ScrollViewer Grid.Row="2" Margin="0,12,0,0">
                        <ItemsControl ItemsSource="{Binding HourlyUsages}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="vm:HourlyUsageItem">
                                    <Border Background="Transparent"
                                            CornerRadius="6"
                                            Padding="12,10"
                                            Margin="0,2">
                                        <Border.Styles>
                                            <Style Selector="Border:pointerover">
                                                <Setter Property="Background" Value="{DynamicResource FlyoutItemHoverColor}" />
                                            </Style>
                                        </Border.Styles>
                                        <Grid ColumnDefinitions="Auto, *, Auto">
                                            <TextBlock Text="{Binding HourFormatted}"
                                                       FontSize="13" FontWeight="Bold"
                                                       Width="60" />
                                            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="16">
                                                <TextBlock Text="{Binding DownloadFormatted}"
                                                           FontSize="12"
                                                           Foreground="{DynamicResource DownloadBrush}" />
                                                <TextBlock Text="{Binding UploadFormatted}"
                                                           FontSize="12"
                                                           Foreground="{DynamicResource UploadBrush}" />
                                            </StackPanel>
                                            <TextBlock Grid.Column="2"
                                                       Text="{Binding TotalFormatted}"
                                                       FontSize="12" FontWeight="Bold" />
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                    
                    <!-- Day Summary -->
                    <Border Grid.Row="3"
                            Background="{DynamicResource BorderSubtleBrush}"
                            CornerRadius="8"
                            Padding="12"
                            Margin="0,12,0,0">
                        <Grid ColumnDefinitions="*, *, *">
                            <StackPanel HorizontalAlignment="Center" Spacing="2">
                                <TextBlock Text="DOWNLOAD" Classes="MetricLabel" FontSize="10" HorizontalAlignment="Center" />
                                <TextBlock Text="{Binding SelectedDay.DownloadFormatted}"
                                           FontSize="14" FontWeight="Bold"
                                           Foreground="{DynamicResource DownloadBrush}"
                                           HorizontalAlignment="Center" />
                            </StackPanel>
                            <StackPanel Grid.Column="1" HorizontalAlignment="Center" Spacing="2">
                                <TextBlock Text="UPLOAD" Classes="MetricLabel" FontSize="10" HorizontalAlignment="Center" />
                                <TextBlock Text="{Binding SelectedDay.UploadFormatted}"
                                           FontSize="14" FontWeight="Bold"
                                           Foreground="{DynamicResource UploadBrush}"
                                           HorizontalAlignment="Center" />
                            </StackPanel>
                            <StackPanel Grid.Column="2" HorizontalAlignment="Center" Spacing="2">
                                <TextBlock Text="TOTAL" Classes="MetricLabel" FontSize="10" HorizontalAlignment="Center" />
                                <TextBlock Text="{Binding SelectedDay.TotalFormatted}"
                                           FontSize="14" FontWeight="Bold"
                                           HorizontalAlignment="Center" />
                            </StackPanel>
                        </Grid>
                    </Border>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</UserControl>
